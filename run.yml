---
- name: install pkgs
  hosts: all,!blokk
  become: true
  gather_facts: false
  vars:
    ansible_ssh_pass: "{{ vault.ansible_become_default_password }}"
  vars_files:
    - "vars/vault.yml"
  roles:
    - role: grog.package
    - role: geerlingguy.pip
    - role: install/pip_packages
    - role: user
      new_user: "{{ vault.user }}"
    - role: install/ssh
    - role: artis3n.tailscale
      tailscale_up_skip: yes
    - role: geerlingguy.docker

# TODO: make a role to install nix packages

- name: set up compose
  hosts: all
  become: true
  gather_facts: false
  vars:
    ansible_ssh_pass: "{{ vault.ansible_become_default_password }}"
  vars_files:
    - "vars/vault.yml"
  roles:
    - role: compose_gen
    - role: caddy

- name: Deploy proxmox infrastructure
  hosts: pve
  become: true
  vars_files:
    - "vars/vault.yml"
  vars:
    ansible_ssh_pass: "{{ vault.proxmox.pass }}"
  pre_tasks:
    - name: Remove enterprise repo
      file:
        state: absent
        path: /etc/apt/sources.list.d/pve-enterprise.list
    - name: Switch to community repo
      apt_repository:
        repo: "deb http://download.proxmox.com/debian/pve bullseye pve-no-subscription"
        state: present
    - name: Apt update
      apt:
        upgrade: "yes"
        update_cache: yes
        cache_valid_time: 3600
  roles:
    - role: install/nag_removal
    - role: grog.package
    - role: geerlingguy.pip
    - role: install/pip_packages
    - role: user
    - role: user
      new_user: "{{ vault.user }}"
    - role: install/ssh
    - role: artis3n.tailscale
      tailscale_up_skip: yes
    - role: install/mergerfs
    # set up proxmox
    - role: pve
    # install docker
    - role: geerlingguy.docker
    # set up all containers (this should be replaced with the
    # addition of the include keyword to docker compose)
    # - role: ironicbadger.docker_compose_generator
    - role: compose_gen
    - role: pihole
    - role: caddy
### LXCs/VMs/VPS
# - name: set up crab
#   hosts: crab
#   become: true
#   vars_files:
#     - "vars/vault.yml"
#   roles:
#     - role: grog.package
#     - role: geerlingguy.docker
#     - role: user
#       new_user: "{{ vault.user }}"
#     - role: install/ssh
#     - role: crab
#     - role: compose_gen

# - name: set up backup
#   hosts: all
#   become: true
#   vars_files:
#     - "vars/vault.yml"
#   roles:
#     - role: grog.package
#       package_list:
#         - name: borgbackup
#         - name: borgmatic
#     - role: backup/borgbase
#     - role: backup/borg
#       borg_encryption_passphrase: "{{ vault.borg_passphrase }}"
#       borg_backup_dirs:
#         - "/home/{{ vault.user }}"
